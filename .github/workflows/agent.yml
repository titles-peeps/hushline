name: agent

on:
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue number to work on"
        required: true
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run-agent:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve issue number
        id: iss
        run: |
          if [[ -n "${{ github.event.inputs.issue }}" ]]; then
            echo "num=${{ github.event.inputs.issue }}" >> "$GITHUB_OUTPUT"
          else
            echo "num=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Run agent
        env:
          GH_TOKEN: ${{ secrets.AGENT_TOKEN }}
          OLLAMA_API_BASE: http://127.0.0.1:11434
          AIDER_MODEL: ollama_chat/qwen2.5-coder:7b-instruct
        run: |
          bash ops/agent.sh "${{ steps.iss.outputs.num }}"
