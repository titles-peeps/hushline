name: run-agent

on:
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue number"
        required: true
        type: string
  issues:
    types: [labeled]

jobs:
  run:
    runs-on: self-hosted

    steps:
      - name: Determine issue number
        id: issue
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "num=${{ inputs.issue }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "issues" && "${{ github.event.action }}" == "labeled" && "${{ github.event.label.name }}" == "agent" ]]; then
            echo "num=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "No issue number available."; exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure LF & executable
        shell: bash
        run: |
          sed -i 's/\r$//' ops/agent.sh || true
          chmod +x ops/agent.sh

      - name: Run agent
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OLLAMA_API_BASE: http://127.0.0.1:11434
          AIDER_MODEL: ollama:qwen2.5-coder:7b-instruct
        run: |
          bash ops/agent.sh "${{ steps.issue.outputs.num }}"
