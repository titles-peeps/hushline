name: run-agent

on:
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue number to work on"
        required: true
        type: string
  issues:
    types: [labeled]

jobs:
  agent:
    runs-on: self-hosted

    env:
      GH_TOKEN: ${{ secrets.AGENT_TOKEN }}
      OLLAMA_API_BASE: http://127.0.0.1:11434
      # âœ“ Use LiteLLM's provider/model syntax (SLASH, not colon)
      AIDER_MODEL: ollama_chat/qwen2.5-coder:7b-instruct
      # (Optional but harmless; keeps LiteLLM happy)
      LITELLM_PROVIDER: ollama

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve issue number
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ISSUE_NUM="${{ github.event.inputs.issue }}"
          else
            if [[ "${{ github.event.action }}" != "labeled" || "${{ github.event.label.name }}" != "agent" ]]; then
              echo "Not an 'agent' label event; skipping."
              echo "skip=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            ISSUE_NUM="${{ github.event.issue.number }}"
          fi
          echo "ISSUE_NUM=${ISSUE_NUM}" >> "$GITHUB_ENV"
          echo "Will work on issue #${ISSUE_NUM}"

      - name: Run agent
        if: steps.resolve.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          echo "Using ISSUE_NUM=$ISSUE_NUM"
          bash ops/agent.sh "$ISSUE_NUM"

      - name: Post Checkout
        if: always()
        run: echo "Done."
