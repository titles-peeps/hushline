name: run-agent

on:
  # Click “Run workflow” OR pass an issue number from the UI
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue number to work on"
        required: true
  # Auto-run when a label is added to an issue
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  agent:
    # Run if:
    # - manually dispatched OR
    # - an issue was labeled with "agent" or "run-agent"
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' &&
       (github.event.action == 'labeled') &&
       contains('agent,run-agent', github.event.label.name))
    runs-on: self-hosted

    # Required env (names unchanged as requested)
    env:
      GH_TOKEN: ${{ secrets.AGENT_TOKEN }}
      OLLAMA_API_BASE: http://127.0.0.1:11434
      # Use Aider’s native Ollama adapter (NOT litellm)
      AIDER_MODEL: ollama_chat/qwen2.5-coder:7b-instruct

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve issue number
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ISSUE_NUM=${{ github.event.inputs.issue }}" >> "$GITHUB_ENV"
          else
            echo "ISSUE_NUM=${{ github.event.issue.number }}" >> "$GITHUB_ENV"
          fi
          echo "Will run agent on issue #$ISSUE_NUM"

      - name: Run agent
        env:
          GH_TOKEN: ${{ env.GH_TOKEN }}
          OLLAMA_API_BASE: ${{ env.OLLAMA_API_BASE }}
          AIDER_MODEL: ${{ env.AIDER_MODEL }}
          # Make sure nothing routes through LiteLLM
          LITELLM_PROVIDER: ""
          LITELLM_OLLAMA_BASE: ""
          OPENAI_API_KEY: ""
          ANTHROPIC_API_KEY: ""
        run: |
          set -euo pipefail
          bash ops/agent.sh "$ISSUE_NUM"
