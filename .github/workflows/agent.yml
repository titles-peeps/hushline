name: run-agent

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      issue:
        description: Issue number to work on
        required: true
  # Auto-trigger when an issue is labeled "agent"
  issues:
    types: [labeled]

jobs:
  agent:
    # Don’t skip: allow manual OR labeled issues with label "agent"
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' &&
       github.event.action == 'labeled' &&
       github.event.label.name == 'agent')

    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve issue number
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ISSUE_NUM=${{ github.event.inputs.issue }}" >> "$GITHUB_ENV"
          else
            echo "ISSUE_NUM=${{ github.event.issue.number }}" >> "$GITHUB_ENV"
          fi
          echo "Will work on issue #${ISSUE_NUM:-<unset>}"

      - name: Run agent
        shell: bash
        env:
          # keep the original token name you’re using
          GH_TOKEN: ${{ secrets.AGENT_TOKEN }}
          # native Ollama endpoint on the runner
          OLLAMA_API_BASE: http://127.0.0.1:11434
          # use the native Aider Ollama adapter name (avoids LiteLLM provider error)
          AIDER_MODEL: ollama_chat/qwen2.5-coder:7b-instruct
        run: |
          set -euo pipefail
          bash ops/agent.sh "$ISSUE_NUM"
