name: Agent Automation
on:
  issues:
    types: [labeled]

jobs:
  run-agent:
    # Only run if the label added is exactly 'agent'
    if: ${{ github.event.label.name == 'agent' }}
    runs-on: self-hosted  # Jetson Orin Nano runner
    container:
      image: ubuntu:22.04
      # Mount the local Ollama model directory into the container
      options: --mount type=bind,source=/home/ubuntu/.ollama,target=/root/.ollama
    # Ensure the workflow can push code and create PRs
    permissions:
      contents: write    # to push branches
      issues: write      # to read issue contents (if needed) and comment/close
      pull-requests: write  # to create pull requests
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install system dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            git jq python3-pip
          pip3 install --no-cache-dir black isort jq

      - name: Run agent script
        run: bash ops/agent.sh
        env:
          AGENT_TOKEN: ${{ secrets.AGENT_TOKEN }}
